<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Manajemen Pengguna | Mulya Teknik</title>

<link rel="icon" type="image/png" href="assets/logo.png" />
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

<!-- ✅ MASTER SHELL CSS (SIDEBAR + JUDUL + TOGGLE + OVERLAY) -->
<link rel="stylesheet" href="assets/css/master-shell.dashboard.css" />

<style>
    /* ================= GLOBAL STYLE & THEME (SAMA DENGAN DASHBOARD) ================= */
    :root {
        color-scheme: light;

        /* BRAND & CORE */
        --primary-color: #0a4a80;
        --secondary-color: #00bcd4;

        /* TEXT */
        --text-color: #1f2933;
        --text-soft: #6b7280;

        /* BACKGROUND / SURFACE */
        --background-light: #f3f7fb;
        --background-dark: #e3eefc;
        --bg-body: radial-gradient(circle at top left, #e0f2ff 0, #f3f7fb 35%, #eef2ff 100%);
        --bg-sidebar: #ffffff;
        --bg-elevated: #ffffff;
        --bg-elevated-soft: #f4f7fa;

        --border-subtle: #e0e0e0;
        --glass-border: rgba(148,163,184,0.35);

        --shadow-deep: 0 20px 50px rgba(15, 23, 42, 0.18);
        --shadow-soft: 0 8px 24px rgba(15,23,42,0.06);

        --input-button-shadow: 0 10px 30px rgba(0, 188, 212, 0.35);

        --sidebar-width: 250px;
        --radius: 16px;

        /* ALIASES UNTUK KOMPONEN */
        --primary: var(--primary-color);
        --secondary: var(--secondary-color);
        --surface: var(--bg-elevated);
        --surface-soft: var(--bg-elevated-soft);
        --text-main: var(--text-color);
        --text-muted: var(--text-soft);

        --danger: #ff4d4f;
        --success: #28a745;
        --warning: #faad14;
        --info: #17a2b8;

        /* ALIASES TAMBAHAN UNTUK HALAMAN USER */
        --surface-card: var(--bg-elevated);
        --surface-card-soft: var(--bg-elevated-soft);
        --status-active-bg: #e6fffb;
        --status-active-border: #bbf7d0;
        --status-active-text: #166534;
        --status-inactive-bg: #fff1f2;
        --status-inactive-border: #fecaca;
        --status-inactive-text: #b91c1c;

        /* ✅ mobile tuning */
        --container-pad: 24px;

        /* ✅ tombol & card lebih kecil (tetap enak ditekan) */
        --tap: 40px;
        --btn-pad-y: 8px;
        --btn-pad-x: 14px;
        --btn-font: 12px;

        --ring: 0 0 0 3px rgba(0,188,212,0.22);

        --card-pad: 14px;
        --card-radius: 16px;
        --gap: 12px;

        /* ✅ modal sizing base */
        --modal-w: 520px;
        --modal-pad: 20px;
        --modal-radius: 18px;

        /* ✅ width acuan untuk posisi X (default desktop tidak dipakai) */
        --sbw: 250px;
    }

    :root[data-theme="dark"] {
        color-scheme: dark;

        --primary-color: #38bdf8;
        --secondary-color: #22d3ee;

        --text-color: #e5e7eb;
        --text-soft: #9ca3af;

        --background-light: #020617;
        --background-dark: #020617;
        --bg-body: radial-gradient(circle at top left, #0b1120 0, #020617 55%, #020617 100%);
        --bg-sidebar: rgba(15,23,42,0.98);
        --bg-elevated: rgba(15,23,42,0.97);
        --bg-elevated-soft: rgba(15,23,42,0.9);

        --border-subtle: rgba(148,163,184,0.5);
        --glass-border: rgba(56,189,248,0.35);

        --shadow-deep: 0 28px 80px rgba(15,23,42,0.9);
        --shadow-soft: 0 20px 60px rgba(15,23,42,0.85);

        --input-button-shadow: 0 20px 60px rgba(8,47,73,0.9);

        --primary: #38bdf8;
        --secondary: #22d3ee;
        --surface: rgba(15,23,42,0.98);
        --surface-soft: rgba(15,23,42,0.9);
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;

        --danger: #f97373;
        --success: #4ade80;
        --warning: #facc15;
        --info: #38bdf8;

        --surface-card: var(--bg-elevated);
        --surface-card-soft: var(--bg-elevated-soft);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    ::-webkit-scrollbar { width: 0px; background: transparent; display: none; }
    html, body { scrollbar-width: none; -ms-overflow-style: none; overflow-x: hidden; }

    body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; }
    button.is-waiting { opacity: 0.7; cursor: wait; }

    /* ✅ Fluid typography */
    html { font-size: 16px; }
    body { font-size: clamp(13px, 1.6vw, 15px); line-height: 1.45; }
    .user-welcome h1 { font-size: clamp(20px, 2.4vw, 28px); line-height: 1.15; }
    .user-welcome p  { font-size: clamp(12px, 1.7vw, 14px); color: var(--text-muted); }

    /* GUARD */
    .table-card, table, thead, tbody, tr, td, th,
    .filter-bar, .modal-wrapper, .modal-content { font-family: 'Poppins', sans-serif; }

    /* ================= HEADER RIGHT ================= */
    .header-right{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        justify-content:flex-end;
        min-width: min(520px, 100%);
    }

    /* Theme toggle */
    .theme-toggle{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: var(--btn-pad-y) var(--btn-pad-x);
        min-height: var(--tap);
        border-radius:999px;
        border:1px solid var(--glass-border);
        background: radial-gradient(circle at top left, rgba(255,255,255,0.96), rgba(226,232,240,0.9));
        color: var(--text-main);
        font-size: var(--btn-font);
        font-weight: 700;
        cursor:pointer;
        box-shadow: 0 10px 22px rgba(15,23,42,0.16);
        transition: transform .18s ease, box-shadow .22s ease, filter .22s ease;
        white-space: nowrap;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    .theme-toggle i{ font-size: 18px; }
    .theme-toggle:hover{ transform: translateY(-1px); box-shadow: 0 16px 40px rgba(15,23,42,0.22); }
    .theme-toggle:active{ transform: translateY(0px) scale(0.99); }
    .theme-toggle:focus-visible{ outline:none; box-shadow: 0 16px 40px rgba(15,23,42,0.22), var(--ring); }
    .theme-toggle.is-dark{
        background: radial-gradient(circle at top left, rgba(15,23,42,0.92), rgba(37,99,235,0.45));
        color: #e5e7eb;
        border-color: rgba(129,140,248,0.7);
    }

    /* Add user button */
    .btn-add-user{
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        color:#fff;
        border:none;
        padding: var(--btn-pad-y) calc(var(--btn-pad-x) + 4px);
        min-height: var(--tap);
        border-radius:999px;
        cursor:pointer;
        font-weight:800;
        font-size: var(--btn-font);
        box-shadow: var(--input-button-shadow);
        display:inline-flex;
        align-items:center;
        gap:8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
        transition: transform .18s ease, filter .2s ease, box-shadow .2s ease;
        -webkit-tap-highlight-color: transparent;
    }
    .btn-add-user i{ font-size: 18px; }

    /* ================= ALERT ================= */
    .alert-container{
        width:100%;
        max-width: 420px;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1500;
        pointer-events: none;
    }
    .alert{
        pointer-events: auto;
        padding: 12px 14px;
        border-radius: 12px;
        font-weight: 600;
        display:flex;
        justify-content:space-between;
        align-items:center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        border:1px solid;
        margin-bottom:12px;
        background: var(--surface);
        color: var(--text-main);
        transition: opacity .2s ease, transform .2s ease;
    }
    .alert-danger{ border-color: rgba(248,113,113,0.9); background:#fee2e2; color:#b91c1c; }
    .alert-success{ border-color: rgba(34,197,94,0.9); background:#dcfce7; color:#166534; }
    :root[data-theme="dark"] .alert-danger{ background: rgba(127,29,29,0.9); color:#fee2e2; }
    :root[data-theme="dark"] .alert-success{ background: rgba(22,163,74,0.9); color:#bbf7d0; }

    /* ================= FILTER BAR ================= */
    .filter-bar{
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
        background: var(--surface);
        padding: 12px 14px;
        border-radius: 18px;
        border: 1px solid rgba(148,163,184,0.3);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
    }
    .filter-bar label{
        display:inline-flex;
        align-items:center;
        gap:8px;
        font-size: 0.92rem;
        font-weight: 700;
        color: var(--text-main);
        white-space: nowrap;
    }
    .filter-bar label i{ color: var(--primary); font-size: 18px; }
    .filter-select{
        padding: 8px 12px;
        min-height: var(--tap);
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        outline: none;
        font-size: 13px;
        cursor: pointer;
        background-color: var(--surface-soft);
        color: var(--text-main);
        width: min(320px, 100%);
        transition: box-shadow .2s ease, border-color .2s ease;
    }
    .filter-select:focus{ border-color: var(--secondary); box-shadow: var(--ring); }

    /* ================= TABLE (Desktop/Tablet) ================= */
    .table-card{
        background: var(--surface);
        padding: 12px 12px 16px 12px;
        box-shadow: var(--shadow-deep);
        border-radius: var(--card-radius);
        border: 1px solid var(--border-subtle);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    table{
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 900px;
    }

    thead{
        background: linear-gradient(115deg,
            rgba(10, 74, 128, 1) 0%,
            rgba(12, 91, 150, 0.98) 40%,
            rgba(0, 166, 196, 0.97) 100%
        );
        box-shadow: 0 10px 24px rgba(15,23,42,0.18);
    }
    :root[data-theme="dark"] thead{
        background: linear-gradient(115deg,
            rgba(37, 99, 235, 0.95) 0%,
            rgba(59, 130, 246, 0.98) 45%,
            rgba(56, 189, 248, 1) 100%
        );
        box-shadow: 0 18px 42px rgba(15,23,42,0.95);
        border-bottom: 1px solid rgba(191, 219, 254, 0.6);
    }

    th{
        color:#f9fafb;
        padding: 11px 10px;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 11.5px;
        text-align: center;
        letter-spacing: 0.06em;
        white-space: nowrap;
    }

    td{
        padding: 10px 10px;
        font-size: 12.8px;
        text-align: center;
        vertical-align: middle;
        background: var(--surface);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 240px;
    }
    tbody tr:nth-child(even) td{ background-color: var(--surface-soft); }
    tbody tr:hover td{ background-color: rgba(226,232,240,0.7); transition: 0.2s; }
    :root[data-theme="dark"] tbody tr:hover td{ background-color: rgba(15,23,42,0.9); }

    .status-badge{
        padding: 5px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 900;
        display: inline-block;
        white-space: nowrap;
    }
    .status-active{ background-color: var(--status-active-bg); color: var(--status-active-text); border: 1px solid var(--status-active-border); }
    .status-inactive{ background-color: var(--status-inactive-bg); color: var(--status-inactive-text); border: 1px solid var(--status-inactive-border); }

    .role-pill{
        background: #e3f2fd;
        color: #0f172a;
        padding: 4px 9px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(148,163,184,0.6);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        max-width: 100%;
    }
    :root[data-theme="dark"] .role-pill{ background: rgba(15,23,42,0.9); color:#e5e7eb; }

    .action-cell{
        white-space: nowrap;
        display: inline-flex;
        align-items:center;
        justify-content:center;
        gap: 6px;
    }
    .action-cell button{
        width: 34px;
        height: 34px;
        border-radius: 12px;
        background: radial-gradient(circle at top left, rgba(255,255,255,0.96), rgba(226,232,240,0.85));
        border: 1px solid rgba(148,163,184,0.55);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
        -webkit-tap-highlight-color: transparent;
    }
    :root[data-theme="dark"] .action-cell button{
        background: rgba(15,23,42,0.92);
        border-color: rgba(148,163,184,0.6);
    }
    .action-cell button i{ font-size: 19px; }
    .action-cell .edit-btn{ color: #faad14; }
    .action-cell .delete-btn{ color: #ff4d4f; }
    .action-cell .restore-btn{ color: #22c55e; }

    /* ================= MODAL (Desktop base) ================= */
    .modal-wrapper{
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1400;
        opacity: 0;
        transition: opacity 0.25s ease;
        padding: 18px;
    }
    .modal-wrapper.active{ display: flex; opacity: 1; }

    .modal-content{
        background: var(--surface);
        width: var(--modal-w);
        max-width: 100%;
        padding: var(--modal-pad);
        box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        max-height: 90vh;
        overflow: hidden;
        border-radius: var(--modal-radius);
        border: 1px solid var(--border-subtle);
        color: var(--text-main);
        transform: translateY(6px);
        transition: transform .25s ease;
        display: flex;
        flex-direction: column;
    }
    .modal-wrapper.active .modal-content{ transform: translateY(0); }

    .modal-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 10px;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(148,163,184,0.25);
        flex: 0 0 auto;
    }
    .modal-header h2{ font-size: 17px; font-weight: 900; color: var(--primary); }

    .modal-body{
        overflow: auto;
        padding-right: 4px;
        flex: 1 1 auto;
    }

    .close-modal{
        background: none;
        border: none;
        width: 38px;
        height: 38px;
        border-radius: 999px;
        cursor: pointer;
        color: var(--text-muted);
        display:inline-flex;
        align-items:center;
        justify-content:center;
        transition: background .2s ease, color .2s ease, transform .15s ease;
        -webkit-tap-highlight-color: transparent;
    }
    .close-modal:hover{ background: rgba(148,163,184,0.16); color: var(--danger); }

    .form-group{ margin-bottom: 12px; }
    .form-group label{
        display:block;
        font-weight: 800;
        margin-bottom: 6px;
        color: var(--text-main);
        font-size: 0.9rem;
    }
    .form-group input, .form-group select{
        width: 100%;
        padding: 10px 12px;
        min-height: var(--tap);
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        background: var(--surface-soft);
        font-size: 13.5px;
        color: var(--text-main);
        transition: box-shadow .2s ease, border-color .2s ease;
    }
    .form-group input:focus, .form-group select:focus{
        border-color: var(--secondary);
        outline: none;
        box-shadow: var(--ring);
    }

    .modal-footer{
        display:flex;
        justify-content:flex-end;
        gap: 10px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(148,163,184,0.25);
        flex-wrap: wrap;
        flex: 0 0 auto;
        position: sticky;
        bottom: 0;
        background: var(--surface);
    }

    .btn-cancel{
        background: var(--surface-soft);
        color: var(--text-main);
        border: 1px solid var(--border-subtle);
        padding: var(--btn-pad-y) var(--btn-pad-x);
        min-height: var(--tap);
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 800;
    }
    .btn-save{
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        color: #ffffff;
        border: none;
        padding: var(--btn-pad-y) calc(var(--btn-pad-x) + 6px);
        min-height: var(--tap);
        border-radius: 999px;
        cursor: pointer;
        font-weight: 900;
        font-size: 0.9rem;
        box-shadow: var(--input-button-shadow);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .confirm-modal{ width: 420px; text-align:center; }
    .confirm-icon{ font-size: 52px; margin-bottom: 10px; }
    .confirm-title{ font-size: 18px; font-weight: 900; margin-bottom: 8px; }
    .confirm-desc{ font-size: 14px; color: var(--text-muted); margin-bottom: 18px; }

    /* ================= RESPONSIVE ================= */

    /* Tablet */
    @media (max-width: 1024px){
        :root{
            --container-pad: 18px;
            --tap: 38px;
            --btn-font: 11.5px;
            --card-pad: 12px;
            --modal-w: 520px;
            --modal-pad: 18px;
        }
        .main-content{ padding: 80px var(--container-pad) 30px var(--container-pad); }
        td{ max-width: 200px; }
        .header-right{ min-width: 0; }
        .filter-select{ width: min(340px, 100%); }
    }

    /* Mobile */
    @media (max-width: 768px){
        :root{
            --container-pad: 12px;
            --tap: 34px;
            --btn-pad-y: 6px;
            --btn-pad-x: 11px;
            --btn-font: 11px;
            --gap: 10px;

            /* ✅ modal lebih kecil */
            --modal-w: 100%;
            --modal-pad: 12px;
            --modal-radius: 16px;

            /* ✅ acuan lebar sidebar aktual untuk posisi X */
            --sbw: min(82vw, 235px);
        }

        /* ✅ SIDEBAR: perkecil ukuran keseluruhan tanpa ubah fungsi master shell */
        .sidebar{
            width: 235px !important;
            max-width: 82vw !important;
        }
        .sidebar .sidebar-header{
            padding: 12px 12px !important;
        }
        .sidebar .sidebar-header img{
            width: 34px !important;
            height: 34px !important;
        }
        .sidebar .brand-text{
            font-size: 13px !important;
            font-weight: 800 !important;
        }
        .sidebar .menu a{
            padding: 10px 12px !important;
            font-size: 12.5px !important;
        }
        .sidebar .menu a i{
            font-size: 18px !important;
        }
        .sidebar .submenu a{
            padding: 9px 12px !important;
            font-size: 12px !important;
        }
        .sidebar .sidebar-footer{
            padding: 12px !important;
        }
        .sidebar .btn-logout{
            min-height: 36px !important;
            padding: 8px 12px !important;
            border-radius: 14px !important;
            font-size: 12px !important;
        }

        /* ✅ FIX (SESUAI DESIGN): tombol X gradasi putih + abu (mobile only) */
        #mobileCloseBtn{
            position: fixed !important;
            top: 12px !important;
            left: calc(var(--sbw) + 10px) !important; /* ✅ tepat di sisi kanan sidebar */
            width: 30px !important;
            height: 30px !important;
            min-width: 30px !important;
            min-height: 30px !important;
            padding: 0 !important;
            border-radius: 10px !important;

            display: none !important;                 /* default hidden */
            align-items: center !important;
            justify-content: center !important;

            z-index: 2005 !important;                 /* di atas overlay */
            border: 1px solid rgba(148,163,184,0.55) !important;

            /* ✅ gradasi putih + sedikit abu (mirip halaman design) */
            background: radial-gradient(circle at top left,
              rgba(255,255,255,0.98),
              rgba(226,232,240,0.86)) !important;

            box-shadow: 0 14px 30px rgba(15,23,42,0.22) !important;
            backdrop-filter: blur(6px);

            /* ikon pakai warna teks tema */
            color: var(--text-main) !important;

            -webkit-tap-highlight-color: transparent;
            transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
        }

        :root[data-theme="dark"] #mobileCloseBtn{
            /* ✅ saat dark, tetap "putih-abu" tapi sedikit lebih muted biar tidak menyilaukan */
            background: radial-gradient(circle at top left,
              rgba(255,255,255,0.92),
              rgba(203,213,225,0.70)) !important;
            border-color: rgba(148,163,184,0.55) !important;
            color: #0f172a !important;
        }

        #mobileCloseBtn:hover{
            transform: translateY(-1px) !important;
            box-shadow: 0 18px 38px rgba(15,23,42,0.26) !important;
            filter: saturate(1.02) !important;
        }
        #mobileCloseBtn:active{
            transform: translateY(0px) scale(0.98) !important;
        }

        #mobileCloseBtn i{
            font-size: 18px !important;
            line-height: 1;
        }

        /* tampil hanya saat sidebar open (master biasanya pakai .active) */
        .sidebar.active ~ #mobileCloseBtn{ display: inline-flex !important; }
        /* kalau sidebar tertutup, sembunyikan */
        .sidebar:not(.active) ~ #mobileCloseBtn{ display: none !important; }

        /* ✅ Header: grid biar rapi + theme toggle icon-only */
        .header-right{
            width: 100%;
            display: grid;
            grid-template-columns: 40px 1fr;
            gap: 10px;
            align-items: center;
            justify-content: unset;
        }

        .theme-toggle{
            width: 40px;
            min-width: 40px;
            height: 34px;
            min-height: 34px;
            padding: 0;
            border-radius: 13px;
            justify-content: center;
            box-shadow: 0 10px 16px rgba(15,23,42,0.10);
        }
        .theme-toggle span{ display:none; }
        .theme-toggle i{ font-size: 17px; }

        .btn-add-user{
            width: 100%;
            justify-content: center;
            min-height: 34px;
            padding: 7px 10px;
        }

        /* alerts */
        .alert-container{
            right: 12px; left: 12px; top: 12px;
            max-width: none;
        }

        /* filter */
        .filter-bar{
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
            padding: 12px;
        }
        .filter-select{ width: 100%; min-height: 34px; }

        /* ✅ table -> card layout */
        .table-card{
            background: transparent;
            box-shadow: none;
            padding: 0;
            border: none;
            overflow: visible;
        }
        table{
            min-width: 0;
            width: 100%;
            display: block;
        }
        thead{ display: none; }
        tbody{ display: block; width: 100%; }

        tbody tr{
            background: var(--surface);
            margin-bottom: 9px;
            padding: 11px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.10);
            border: 1px solid rgba(148,163,184,0.20);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        td{
            display: grid;
            grid-template-columns: minmax(105px, 44%) 1fr;
            gap: 8px;
            align-items: start;
            text-align: right;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148,163,184,0.20);
            background: transparent !important;
            white-space: normal;
            max-width: none;
            font-size: 12px;
        }
        td::before{
            content: attr(data-label);
            font-weight: 900;
            color: var(--primary);
            text-align: left;
            font-size: 12px;
        }
        td > *{
            justify-self: end;
            text-align: right;
            max-width: 100%;
        }
        .role-pill, .status-badge{
            justify-self: end;
            margin-left: auto;
            font-size: 11px;
        }
        .role-pill{ padding: 3px 8px; }
        .status-badge{ padding: 4px 8px; }

        td:last-child{
            border-bottom: none;
            padding-top: 9px;
        }

        .action-cell{
            width: 100%;
            justify-content: flex-end;
            gap: 7px;
        }
        .action-cell button{
            width: 40px;
            height: 34px;
            border-radius: 13px;
            background: var(--surface-soft) !important;
            border: 1px solid rgba(148,163,184,0.32);
            box-shadow: 0 10px 16px rgba(15,23,42,0.08);
        }
        :root[data-theme="dark"] .action-cell button{
            background: rgba(15,23,42,0.92) !important;
        }
        .action-cell button i{ font-size: 19px; }

        /* ✅ modal jadi bottom sheet yang lebih kecil */
        .modal-wrapper{
            align-items: flex-end;
            padding: 0;
        }
        .modal-content{
            width: 100%;
            max-width: 100%;
            border-radius: 16px 16px 0 0;
            padding: 12px 12px 10px 12px;
            max-height: 78vh;                 /* ✅ lebih pendek */
            border-left: none;
            border-right: none;
            border-bottom: none;
        }
        .modal-header{
            margin-bottom: 10px;
            padding-bottom: 8px;
        }
        .modal-header h2{ font-size: 14.5px; }

        .close-modal{
            width: 34px;
            height: 34px;
            border-radius: 12px;
            font-size: 22px;
        }

        .modal-body{
            max-height: calc(78vh - 118px);    /* ✅ lebih compact */
            overflow: auto;
            padding-right: 2px;
        }

        .form-group{ margin-bottom: 10px; }
        .form-group label{ font-size: 12.5px; margin-bottom: 5px; }

        .form-group input, .form-group select{
            padding: 9px 11px;
            min-height: 34px;
            border-radius: 12px;
            font-size: 12.5px;
        }

        .modal-footer{
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
        }
        .btn-cancel, .btn-save{
            min-height: 34px;
            padding: 7px 12px;
            font-size: 12px;
        }

        /* ✅ confirm modal juga lebih kecil */
        .modal-content.confirm-modal{
            width: 92vw;
            max-width: 92vw;
            padding: 14px;
            border-radius: 16px;
            max-height: 76vh;
        }
        .confirm-icon{ font-size: 44px; margin-bottom: 8px; }
        .confirm-title{ font-size: 15.5px; }
        .confirm-desc{ font-size: 12.5px; margin-bottom: 14px; }
    }

    /* Small phones */
    @media (max-width: 480px){
        :root{
            --container-pad: 10px;
            --tap: 32px;
            --btn-pad-y: 6px;
            --btn-pad-x: 10px;
            --btn-font: 10.8px;

            /* ✅ update acuan sbw sesuai sidebar kecil */
            --sbw: min(84vw, 220px);
        }

        .sidebar{
            width: 220px !important;
            max-width: 84vw !important;
        }
        .sidebar .menu a{ padding: 9px 11px !important; }
        .sidebar .menu a i{ font-size: 17px !important; }

        td{ grid-template-columns: minmax(98px, 42%) 1fr; gap: 8px; }

        .theme-toggle{
            width: 38px;
            height: 32px;
            min-height: 32px;
            border-radius: 12px;
        }

        .btn-add-user{ font-size: 10.8px; }

        .action-cell button{
            width: 38px;
            height: 32px;
            border-radius: 12px;
        }

        .modal-content{
            padding: 11px 11px 9px 11px;
            max-height: 74vh;
        }
        .modal-body{ max-height: calc(74vh - 112px); }

        .confirm-title{ font-size: 15px; }
        .confirm-desc{ font-size: 12px; }

        /* ✅ posisi X ikut menyesuaikan + tetap gradasi putih-abu */
        #mobileCloseBtn{
            top: 10px !important;
            left: calc(var(--sbw) + 10px) !important;
            width: 28px !important;
            height: 28px !important;
            min-width: 28px !important;
            min-height: 28px !important;
            border-radius: 10px !important;
        }
        #mobileCloseBtn i{ font-size: 17px !important; }
    }

    @media (max-width: 350px){
        td{ grid-template-columns: minmax(90px, 40%) 1fr; }
        .action-cell button{ width: 36px; }
        .sidebar{ width: 210px !important; }

        :root{ --sbw: min(84vw, 210px); }

        #mobileCloseBtn{
            left: calc(var(--sbw) + 10px) !important;
        }
    }
</style>
</head>
<body>

<!-- ✅ SIDEBAR (DI-STYLING OLEH master-shell.dashboard.css) -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img src="assets/logo.png" alt="Logo" onerror="this.style.display='none'">
    <span class="brand-text">Mulya Teknik</span>
  </div>

  <ul class="menu">
    <li><a href="dashboard.html"><i class='bx bxs-dashboard'></i> <span class="menu-text">Dashboard</span></a></li>
    <li><a href="design.html"><i class='bx bxs-color-fill'></i> <span class="menu-text">Design</span></a></li>
    <li><a href="laporan.html"><i class='bx bxs-bar-chart-alt-2'></i> <span class="menu-text">Laporan</span></a></li>
    <li><a href="user.html"><i class='bx bxs-group'></i> <span class="menu-text">Pengguna</span></a></li>

    <li class="has-submenu">
      <a href="javascript:void(0);">
        <i class='bx bxs-buildings'></i>
        <span class="menu-text">Proyek</span>
        <i class='bx bx-chevron-down submenu-toggle-icon'></i>
      </a>
      <ul class="submenu">
        <li><a href="leads.html">Leads</a></li>
        <li><a href="daftar_proyek.html">Daftar Proyek</a></li>
        <li><a href="proyek_batal.html">Proyek Batal</a></li>
      </ul>
    </li>
  </ul>

  <div class="sidebar-footer">
    <button class="btn-logout" onclick="logout()">
      <i class='bx bx-log-out'></i> <span>Keluar</span>
    </button>
  </div>
</div>

<button class="toggle-btn" id="toggleBtn"><i class='bx bx-menu'></i></button>
<button class="mobile-close-btn" id="mobileCloseBtn"><i class='bx bx-x'></i></button>
<div class="overlay" id="overlay"></div>

<div class="main-content">
    <div class="alert-container"></div>

    <div class="page-header">
        <div class="user-welcome">
            <h1>Manajemen Pengguna</h1>
            <p>Kelola akun dan hak akses internal tim konstruksi baja.</p>
        </div>
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme">
                <i class='bx bx-moon'></i>
                <span>Dark</span>
            </button>
            <button type="button" class="btn-add-user" onclick="bukaModal('tambah')">
                <i class='bx bx-plus-circle'></i> Input Pengguna Baru
            </button>
        </div>
    </div>

    <div class="filter-bar">
        <label><i class='bx bx-filter'></i> Tampilkan:</label>
        <select id="statusFilter" class="filter-select" onchange="applyFilter()">
            <option value="all">Semua Data</option>
            <option value="Aktif" selected>Pengguna Aktif</option>
            <option value="Non-Aktif">Non-Aktif (Arsip)</option>
        </select>
    </div>

    <div class="table-card">
        <table id="userTable">
            <thead>
                <tr>
                    <th style="display:none;">ID</th>
                    <th>Nama Lengkap</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Telepon</th>
                    <th>Peran</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- FORM MODAL -->
<div class="modal-wrapper" id="formModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Input Pengguna</h2>
            <button class="close-modal" onclick="tutupModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="userId">
            <div class="form-group"><label>Nama Lengkap</label><input type="text" id="nama" placeholder="Contoh: Andi Pratama"></div>
            <div class="form-group"><label>Username</label><input type="text" id="username" placeholder="Contoh: andi123"></div>
            <div class="form-group"><label>Password</label><input type="text" id="password" placeholder="Kosongkan jika tidak ingin mengubah password"></div>
            <div class="form-group"><label>Email</label><input type="email" id="email" placeholder="contoh@email.com"></div>
            <div class="form-group">
                <label>Telepon</label>
                <input type="text" id="telepon" placeholder="0812..." maxlength="15" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 15)">
            </div>
            <div class="form-group"><label>Peran</label>
                <select id="peran">
                    <option value="1">Admin</option>
                    <option value="2">Digital Marketing</option>
                    <option value="3">Managemen</option>
                    <option value="4">Tim Studio</option>
                    <option value="5">Tim Lapangan</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="tutupModal()">Batal</button>
            <button class="btn-save" onclick="konfirmasiSimpan()">Simpan</button>
        </div>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-wrapper" id="confirmModal">
    <div class="modal-content confirm-modal">
        <i class='bx bx-help-circle confirm-icon' id="confirmIcon" style="color:var(--primary-color)"></i>
        <h3 class="confirm-title" id="confirmTitle">Konfirmasi</h3>
        <p class="confirm-desc" id="confirmDesc">Apakah Anda yakin?</p>
        <div class="modal-footer" style="justify-content: center;">
            <button class="btn-cancel" onclick="tutupKonfirmasi()">Batal</button>
            <button class="btn-save" id="btnConfirmYes">Ya, Lanjutkan</button>
        </div>
    </div>
</div>

<script src="assets/js/master-shell.dashboard.js"></script>

<script>
    // ================= CONFIG & THEME (SAMA DASHBOARD) =================
    const BASE_URL = "https://mt-optima-api-176148115028.asia-southeast2.run.app";
    const API_USERS_URL = `${BASE_URL}/api/admin/users`;

    const AUTH_TOKEN = (localStorage.getItem('token') || '');
    const THEME_KEY = 'mt-theme';

    function applyTheme(theme) {
        if (theme !== 'dark' && theme !== 'light') theme = 'light';
        const root = document.documentElement;
        root.setAttribute('data-theme', theme);
        localStorage.setItem(THEME_KEY, theme);
        updateThemeToggleUI(theme);
    }

    function updateThemeToggleUI(theme) {
        const toggle = document.getElementById('themeToggle');
        if (!toggle) return;
        const icon = toggle.querySelector('i');
        const label = toggle.querySelector('span');
        if (theme === 'dark') {
            toggle.classList.add('is-dark');
            if (icon) {
                icon.classList.remove('bx-moon');
                icon.classList.add('bx-sun');
            }
            if (label) label.textContent = 'Light';
        } else {
            toggle.classList.remove('is-dark');
            if (icon) {
                icon.classList.remove('bx-sun');
                icon.classList.add('bx-moon');
            }
            if (label) label.textContent = 'Dark';
        }
    }

    function initThemeToggle() {
        const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
        applyTheme(savedTheme);
        const toggle = document.getElementById('themeToggle');
        if (!toggle) return;
        toggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const next = current === 'light' ? 'dark' : 'light';
            applyTheme(next);
        });
    }

    // ================= LOGOUT =================
    async function logout() {
        try {
            await fetch(`${BASE_URL}/api/logout`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AUTH_TOKEN}`,
                    'Accept': 'application/json'
                }
            });
        } catch (e) {
            console.error('Logout error:', e);
        } finally {
            localStorage.removeItem('token');
            localStorage.removeItem('mt_progress_reminder_last_date');
            window.location.href = 'login.html';
        }
    }

    // ================== DATA & CRUD USER ==================
    const roleMap = {
        1: 'Admin',
        2: 'Digital Marketing',
        3: 'Managemen',
        4: 'Tim Studio',
        5: 'Tim Lapangan'
    };

    let usersData = [];
    let currentMode = 'tambah';
    let actionId = null;
    let actionType = '';

    async function fetchUsers() {
        if (!AUTH_TOKEN) {
            tampilkanAlert("Token tidak valid. Silakan login ulang.", "danger");
            setTimeout(() => location.href = 'login.html', 2000);
            return;
        }
        try {
            const url = `${API_USERS_URL}?t=${Date.now()}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${AUTH_TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            if (!response.ok) throw new Error(`Gagal Load Data: ${response.status} ${response.statusText}`);
            const textData = await response.text();
            let result;
            try {
                result = JSON.parse(textData);
            } catch {
                throw new Error("Respon server error (HTML Warning).");
            }
            const rawData = result.data || (Array.isArray(result) ? result : []);
            usersData = rawData.map(u => {
                const s = String(u.status).toLowerCase().trim();
                let statusUI = 'Aktif';
                if (s === 'nonaktif' || s === 'non-aktif' || s === '0' || s === 'false' || s === 'inactive') {
                    statusUI = 'Non-Aktif';
                }
                return { ...u, statusUI };
            });
            usersData.sort((a, b) => (a.statusUI === 'Non-Aktif') ? 1 : -1);
            renderTable();
        } catch (err) {
            console.error(err);
            tampilkanAlert("Gagal Koneksi: " + err.message, "danger");
        }
    }

    function applyFilter() { renderTable(); }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const filterValue = document.getElementById('statusFilter').value;
        tbody.innerHTML = '';
        let filtered = usersData;
        if (filterValue !== 'all') {
            filtered = usersData.filter(u => u.statusUI === filterValue);
        }
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="padding:20px; text-align:center; color:var(--text-muted);">Tidak ada data (${filterValue}).</td></tr>`;
            return;
        }
        filtered.forEach(user => {
            const tr = document.createElement('tr');
            let rId = (user.role && typeof user.role === 'object') ? user.role.id : (user.role_id || user.role);
            let roleName = roleMap[rId] || 'User';
            let phone = user.telepon || user.phone || user.no_hp || '-';
            let statusBadge = '';
            let buttons = '';
            if (user.statusUI === 'Aktif') {
                statusBadge = '<span class="status-badge status-active">Aktif</span>';
                buttons = `
                    <button class="edit-btn" onclick="bukaModal('edit', '${user.id}')" title="Edit Data"><i class='bx bx-edit-alt'></i></button>
                    <button class="delete-btn" onclick="konfirmasiAksi('${user.id}', 'soft_delete')" title="Hapus (Non-Aktifkan)"><i class='bx bx-x'></i></button>
                `;
            } else {
                statusBadge = '<span class="status-badge status-inactive">Non-Aktif</span>';
                buttons = `<button class="restore-btn" onclick="konfirmasiAksi('${user.id}', 'restore')" title="Pulihkan (Aktifkan)"><i class='bx bx-history'></i></button>`;
            }
            tr.innerHTML = `
                <td style="display:none;">${user.id}</td>
                <td data-label="Nama Lengkap"><strong>${user.name || user.nama}</strong></td>
                <td data-label="Username">${user.username}</td>
                <td data-label="Email">${user.email}</td>
                <td data-label="Telepon">${phone}</td>
                <td data-label="Peran"><span class="role-pill">${roleName}</span></td>
                <td data-label="Status">${statusBadge}</td>
                <td data-label="Aksi" class="action-cell">${buttons}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function bukaModal(mode, id = null) {
        const modal = document.getElementById('formModal');
        const title = document.getElementById('modalTitle');
        currentMode = mode;

        document.getElementById('userId').value = '';
        document.getElementById('nama').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('email').value = '';
        document.getElementById('telepon').value = '';
        document.getElementById('peran').value = '1';

        if (mode === 'edit') {
            title.textContent = 'Edit Pengguna';
            const user = usersData.find(u => u.id == id);
            if (user) {
                document.getElementById('userId').value = user.id;
                document.getElementById('nama').value = user.name || user.nama;
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('telepon').value = user.telepon || user.phone || '';
                let rId = (user.role && typeof user.role === 'object') ? user.role.id : (user.role_id || user.role);
                document.getElementById('peran').value = rId || 1;
            }
        } else {
            title.textContent = 'Input Pengguna Baru';
        }
        modal.classList.add('active');
    }

    function tutupModal() { document.getElementById('formModal').classList.remove('active'); }

    function konfirmasiSimpan() {
        const nama = document.getElementById('nama').value;
        const username = document.getElementById('username').value;
        if (!nama || !username) {
            tampilkanAlert("Nama dan Username wajib diisi!", "danger");
            return;
        }
        siapkanKonfirmasi(
            "Simpan Data",
            "Pastikan data pengguna sudah sesuai sebelum disimpan.",
            "bx-save",
            "#0a4a80",
            () => prosesSimpan()
        );
    }

    async function prosesSimpan() {
        const id = document.getElementById('userId').value;
        const payload = {
            name: document.getElementById('nama').value,
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            telepon: document.getElementById('telepon').value,
            role_id: parseInt(document.getElementById('peran').value)
        };
        const pass = document.getElementById('password').value;
        if (pass && pass.trim() !== "") payload.password = pass;

        let url = API_USERS_URL;
        let method = 'POST';
        if (currentMode === 'edit') {
            url = `${API_USERS_URL}/${id}`;
            method = 'PUT';
            const existingUser = usersData.find(u => u.id == id);
            payload.status = existingUser ? existingUser.status : 'Aktif';
        } else {
            payload.status = 'Aktif';
        }

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Authorization': `Bearer ${AUTH_TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            const resData = await response.json();
            if (!response.ok) throw new Error(resData.message || "Gagal menyimpan.");

            tampilkanAlert("Berhasil disimpan!", "success");
            tutupModal();
            tutupKonfirmasi();
            await fetchUsers();
        } catch (err) {
            tampilkanAlert(err.message, "danger");
            tutupKonfirmasi();
        }
    }

    function konfirmasiAksi(id, type) {
        actionId = id;
        actionType = type;
        let title, desc, icon, color;
        if (type === 'soft_delete') {
            title = 'Non-Aktifkan User?';
            desc = 'User akan dipindahkan ke status Non-Aktif.';
            icon = 'bx-x';
            color = '#ff4d4f';
        } else {
            title = 'Pulihkan User?';
            desc = 'User akan kembali Aktif.';
            icon = 'bx-history';
            color = '#22c55e';
        }
        siapkanKonfirmasi(title, desc, icon, color, () => jalankanAksi());
    }

    async function jalankanAksi() {
        try {
            let url = `${API_USERS_URL}/${actionId}`;
            let method = (actionType === 'soft_delete') ? 'DELETE' : 'PUT';
            let bodyData = null;

            if (actionType === 'restore') {
                const user = usersData.find(u => u.id == actionId);
                if (!user) throw new Error("Data user tidak ditemukan.");
                bodyData = {
                    name: user.name,
                    username: user.username,
                    email: user.email,
                    telepon: user.telepon || user.phone,
                    role_id: user.role_id,
                    status: 'Aktif'
                };
            }

            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${AUTH_TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            if (bodyData) options.body = JSON.stringify(bodyData);

            const response = await fetch(url, options);
            const resData = await response.json();
            if (!response.ok) throw new Error(resData.message || "Gagal memproses aksi.");

            const idx = usersData.findIndex(u => u.id == actionId);
            if (idx !== -1) {
                if (actionType === 'soft_delete') {
                    usersData[idx].status = 'Nonaktif';
                    usersData[idx].statusUI = 'Non-Aktif';
                } else {
                    usersData[idx].status = 'Aktif';
                    usersData[idx].statusUI = 'Aktif';
                }
                usersData.sort((a, b) => (a.statusUI === 'Non-Aktif') ? 1 : -1);
            }
            renderTable();
            tampilkanAlert(actionType === 'soft_delete' ? "User dinon-aktifkan." : "User diaktifkan kembali.", "success");
            tutupKonfirmasi();
        } catch (err) {
            tampilkanAlert("Server Error: " + err.message, "danger");
            tutupKonfirmasi();
        }
    }

    const confirmModal = document.getElementById('confirmModal');

    function siapkanKonfirmasi(judul, deskripsi, iconClass, color, callback) {
        document.getElementById('confirmTitle').textContent = judul;
        document.getElementById('confirmDesc').textContent = deskripsi;

        const iconElem = document.getElementById('confirmIcon');
        iconElem.className = `bx ${iconClass} confirm-icon`;
        iconElem.style.color = color || '#333';

        const oldBtn = document.getElementById('btnConfirmYes');
        const newBtn = oldBtn.cloneNode(true);
        oldBtn.replaceWith(newBtn);

        newBtn.style.backgroundImage = 'none';
        newBtn.style.backgroundColor = color || 'var(--primary-color)';
        newBtn.addEventListener('click', callback);

        confirmModal.classList.add('active');
    }

    function tutupKonfirmasi() { confirmModal.classList.remove('active'); }

    function tampilkanAlert(pesan, tipe = 'danger') {
        const container = document.querySelector(".alert-container");
        const div = document.createElement("div");
        div.className = `alert alert-${tipe}`;
        div.innerHTML = `<div style="display:flex; align-items:center; gap:8px;">
            <i class='bx ${tipe === 'danger' ? 'bxs-x-circle' : 'bxs-check-circle'}' style="font-size:20px;"></i>
            <span>${pesan}</span>
        </div>`;
        container.appendChild(div);
        setTimeout(() => {
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 250);
        }, 4000);
    }

    document.addEventListener("DOMContentLoaded", () => {
        initThemeToggle();

        if (window.MasterShell && typeof window.MasterShell.initGlobalButtonDebounce === 'function') {
            window.MasterShell.initGlobalButtonDebounce();
        }

        fetchUsers();
    });
</script>
</body>
</html>
